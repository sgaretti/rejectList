#include <fstream>
#include <iostream>
#include <stdlib.h>
#include <set>

#include "TCanvas.h"
#include "TColor.h"
#include "TDirectory.h"
#include "TFile.h"
#include "TH1F.h"
#include "TH2F.h"
#include "TList.h"
#include "TROOT.h"
#include "TStyle.h"
#include "TSystem.h"

void SetStyle() {
  gStyle->SetLineScalePS(1.2);
  gStyle->SetOptStat(0);
  gStyle->SetLegendBorderSize(0);
  gStyle->SetTitleOffset(1.25, "XYZ");
  gStyle->SetTitleSize(0.04, "XYZ");
  gStyle->SetLabelSize(0.04, "XYZ");
  gStyle->SetTitleFont(42, "XYZ");
  gStyle->SetLabelFont(42, "XYZ");
  gStyle->SetTextSize(0.04);
  gStyle->SetTextFont(42);
  gStyle->SetPalette(1);
  // TColor::InvertPalette();
}

void setHist(TH2D* h)
{
  h->GetYaxis()->SetTickSize(0.01);
  h->GetXaxis()->SetLabelSize(0.03);
  h->GetYaxis()->SetLabelSize(0.03);
  h->GetXaxis()->SetTitleSize(0.04);
  h->GetYaxis()->SetTitleSize(0.04);
  h->GetXaxis()->SetTitleOffset(1.05);
  h->GetYaxis()->SetTitleOffset(1.);
  h->GetYaxis()->SetMaxDigits(5);
  h->LabelsOption("av");
  h->SetContour(20);
}

// runMin, runMax, dsMin, dsMax
std::vector<std::tuple<int,int,int,int>> bannedRectangles =
{
  // 100
  {544913,544914,  228,  232},
  {544474,544813,  243,  243},
  {544013,545312,  248,  252},
  {544013,545312,  255,  255},
  {544013,545312,  272,  273},
  {544013,544813,  305,  305},
  {544886,544968,  366,  366},
  {544068,544968,  408,  408},
  {544116,544392,  408,  410},
  {544992,545312,  408,  410},
  // 101
  {544813,544886,  526,  530},
  {544887,544964,  526,  529},
  {545009,545047,  526,  530},
  {544013,545312,  561,  561},
  {544868,545312,  596,  596},
  {544013,545312,  634,  634},
  {544583,544696,  717,  717},
  {544124,544931,  739,  741},
  {544013,545009,  759,  760},
  {544124,544931,  767,  767},
  {544968,545210,  831,  831},
  {544968,545210,  833,  834},
  {544672,544674,  889,  889},
  {544754,544754,  889,  889},
  // 102
  {544968,545312,  923,  923},
  {544013,544964,  932,  933},
  {544013,545312,  967,  967},
  {544013,545312,  984,  986},
  {544013,545312,  995,  995},
  {544013,545312,  997,  997},
  {545044,545312,  998,  998},
  {544013,545312,  999, 1002},
  {544013,545312, 1007, 1007},
  {544013,544098, 1038, 1040},
  {544580,544585, 1038, 1040},
  {544123,544123, 1039, 1039},
  {544474,544474, 1039, 1039},
  {544549,544549, 1039, 1039},
  {544570,544794, 1039, 1039},
  {544013,545312, 1084, 1084},
  {544013,545312, 1170, 1170},
  {545009,545312, 1176, 1178},
  {544564,544565, 1176, 1178},
  {544013,545312, 1128, 1128},
  {544013,545312, 1148, 1148},
  {544013,545312, 1207, 1207},
  {544013,544640, 1213, 1216},
  {544652,545312, 1215, 1216},
  {544389,544964, 1219, 1219},
  {544013,544185, 1268, 1270},
  {544013,544185, 1292, 1293},
  {544390,544614, 1292, 1292},
  {544392,544474, 1268, 1268},
  {544508,544515, 1268, 1268},
  {544392,544474, 1270, 1270},
  {544508,544515, 1270, 1270},
  {544564,544568, 1268, 1268},
  {544564,544568, 1270, 1270},
  {544585,544614, 1268, 1268},
  {544585,544614, 1270, 1270},
  {544968,545312, 1247, 1247},
  {544013,545312, 1330, 1330},
  {544013,545312, 1343, 1343},
  {544013,545312, 1348, 1348},
  {544013,545312, 1351, 1352},
  // 103
  {544013,545312, 1444, 1444},
  {544013,544032, 1673, 1674},
  {544013,544640, 1680, 1684},
  {544013,544968, 1574, 1578},
  {544013,545312, 1408, 1410},
  {544013,545312, 1455, 1455},
  {544013,545312, 1470, 1472},
  {544013,545312, 1498, 1498},
  {544013,545312, 1632, 1636},
  {544013,545312, 1640, 1641},
  {544013,545312, 1643, 1643},
  {544013,545312, 1650, 1641},
  {544013,545312, 1654, 1657},
  {544013,545312, 1661, 1662},
  {544013,545312, 1665, 1665},
  {544013,545312, 1669, 1669},
  {544013,545312, 1731, 1731},
  {544013,545312, 1754, 1755},
  {544640,544813, 1606, 1607},
  {544640,545249, 1471, 1471},
  {544652,544813, 1680, 1681},
  {544652,544813, 1683, 1683},
  {544013,545312, 1622, 1622},
  {544013,545312, 1624, 1626},
  {544968,544968, 1674, 1674},
  {544968,545064, 1673, 1673},
  {544013,544185, 1673, 1673},
  {544013,544032, 1674, 1674},
  {544968,545312, 1726, 1732},
  {545063,545296, 1436, 1436},
  {544013,545312, 1715, 1717},
  {544013,545312, 1699, 1699},
  {544013,545312, 1780, 1780},
  // 200
  {544013,545312, 1850, 1850},
  {544013,545312, 1895, 1895},
  {544013,545312, 1914, 1914},
  {544013,545312, 2109, 2109},
  {544013,545312, 2049, 2049},
  {544013,545312, 2087, 2087},
  {544013,545312, 2092, 2093},
  {544013,545312, 2121, 2121},
  {544968,545312, 2171, 2171},
  {544013,545312, 2245, 2245},
  // 201
  {544013,545312, 2296, 2296},
  {544868,545312, 2302, 2302},
  {545044,545312, 2323, 2323},
  {544013,544797, 2483, 2483},
  {544013,545312, 2484, 2484},
  {544794,545312, 2485, 2485},
  {544013,545312, 2486, 2486},
  {544013,545312, 2554, 2555},
  {544868,545312, 2513, 2513},
  // 202
  {544013,545312, 2706, 2709},
  {544013,545312, 2711, 2711},
  {544013,545312, 2726, 2729},
  {544013,545312, 2732, 2732},
  {544013,545312, 2743, 2744},
  {544013,545312, 2747, 2750},
  {544013,545312, 2765, 2767},
  {544013,545312, 2771, 2774},
  {544013,545312, 2797, 2800},
  {544013,545312, 2823, 2826},
  {544013,545312, 2847, 2849},
  {544013,545312, 2871, 2872},
  {544013,545312, 2889, 2890},
  {544390,544794, 2896, 2896},
  {545185,545312, 2896, 2897},
  {544640,544767, 2897, 2897},
  {544013,545312, 2902, 2902},
  {544013,545312, 2919, 2919},
  // NB
  {544013,545312, 2932, 2935},
  {544013,545312, 2952, 2955},
  {544013,545312, 2973, 2976},
  {544868,545312, 2989, 2989},
  {544013,545312, 2997, 3000},
  {544013,545312, 3023, 3026},
  {544013,545312, 3048, 3050},
  {544013,545312, 3066, 3066},
  {544013,545312, 3072, 3074},
  {544013,545312, 3096, 3097},
  {544013,545312, 3114, 3115},
  {544013,545312, 3127, 3127},
  // 203 B
  {544476,544797, 3157, 3157},
  {544013,545312, 3158, 3158},
  {545185,545312, 3157, 3158},
  {545185,545312, 3177, 3178},
  {544389,544797, 3177, 3178},
  {544961,544964, 3177, 3178},
  {544961,544964, 3199, 3199},
  {544389,544797, 3199, 3199},
  {545185,545312, 3199, 3199},
  {544968,545312, 3259, 3260},
  {544013,545312, 3267, 3267},
  {544548,544917, 3349, 3349},
  // NB
  {544013,545312, 3524, 3524},
  {544013,545312, 3603, 3603},
  // 300 B
  {544013,544548, 3617, 3618},
  {544013,544548, 3620, 3621},
  {544013,545312, 3651, 3651},
  {544013,545312, 3669, 3669},
  {544013,545312, 3745, 3745},
  {544013,545312, 3757, 3759},
  {544013,545312, 3770, 3774},
  {544013,545312, 3800, 3802},
  {544013,545312, 3804, 3804},
  {544013,545312, 3813, 3814},
  {544013,545312, 3820, 3823},
  // NB
  {544013,545312, 3945, 3947},
  {544013,545312, 3998, 3998},
  {544013,544510, 4026, 4026},
  {544868,545312, 4027, 4027},
  {544868,545312, 4029, 4029},
  {544013,544510, 4029, 4029},
  // 301 B
  {544013,545312, 4055, 4055},
  {544013,544813, 4099, 4099},
  {544013,544813, 4101, 4101},
  {544013,545312, 4102, 4102},
  {544013,545312, 4104, 4106},
  {544013,545312, 4110, 4110},
  {544013,545312, 4112, 4112},
  {544013,545312, 4117, 4117},
  {544013,545312, 4162, 4162},
  {544013,544797, 4176, 4176},
  {544013,545312, 4207, 4207},
  {544013,545312, 4212, 4212},
  {544013,545312, 4225, 4225},
  {544013,545312, 4245, 4245},
  {544013,545312, 4262, 4262},
  {544013,545312, 4264, 4265},
  // NB
  {544013,545312, 4290, 4290},
  {544013,545312, 4290, 4290},
  {544868,545312, 4322, 4322},
  {544013,545312, 4323, 4324},
  {544013,545312, 4332, 4332},
  {544590,545312, 4333, 4333},
  {544013,544813, 4380, 4380},
  {544013,544797, 4391, 4391},
  {544868,545312, 4402, 4402},
  {544868,545312, 4411, 4411},
  {544013,545009, 4434, 4434},
  {544013,545009, 4436, 4436},
  {544013,545312, 4440, 4440},
  {544013,544797, 4454, 4454},
  {544013,545249, 4472, 4472},
  {544013,545249, 4475, 4475},
  {544013,545312, 4482, 4482},
  {544868,545312, 4483, 4483},
  {544917,545312, 4484, 4485},
  {544868,545312, 4486, 4486},
  // 302 B
  {544013,545312, 4521, 4526},
  {544013,545312, 4529, 4529},
  {544013,545312, 4534, 4534},
  {544013,545312, 4579, 4581},
  {544013,545312, 4592, 4592},
  {544013,545312, 4595, 4596},
  {544013,545312, 4602, 4605},
  {544013,545312, 4607, 4608},
  {544013,545312, 4629, 4629},
  {544013,545312, 4654, 4654},
  {544013,545312, 4675, 4675},
  {544013,545312, 4687, 4687},
  {544013,545312, 4689, 4693},
  // NB
  {544013,545312, 4738, 4738},
  {544013,545312, 4882, 4882},
  {544013,545312, 4905, 4905},
  // 303 B
  {544013,545312, 4948, 4948},
  {544013,545312, 4953, 4953},
  {544013,545312, 4989, 4991},
  {544013,545312, 5011, 5011},
  {544013,545312, 5071, 5071},
  {544013,545312, 5117, 5117},
  {544013,545312, 5129, 5129},
  // NB
  {544013,545312, 5169, 5169},
  {544013,544813, 5210, 5211},
  {544013,544813, 5258, 5258},
  {544931,545312, 5259, 5259},
  {544013,545312, 5292, 5292},
  {544013,545312, 5338, 5338},
  // 400 B
  {544013,545312, 5376, 5377},
  {544013,545312, 5466, 5466},
  {544013,545312, 5513, 5513},
  {544013,545312, 5538, 5538},
  {544013,545312, 5571, 5571},
  // NB
  {544013,545312, 5607, 5607},
  {544767,545312, 5607, 5611},
  {544013,544492, 5609, 5611},
  {544013,545312, 5646, 5647},
  {544013,545312, 5669, 5669},
  {544013,545312, 5673, 5673},
  {544013,545312, 5737, 5737},
  {544013,544813, 5745, 5745},
  {544813,545312, 5746, 5748},
  {544013,545312, 5815, 5815},
  // 401 B
  {544868,545312, 5837, 5837},
  {544013,545312, 5852, 5852},
  {544013,545312, 5854, 5856},
  {544013,545312, 5867, 5867},
  {544013,545312, 5870, 5870},
  {544013,545312, 5874, 5879},
  {544013,545312, 5902, 5904},
  {544013,545312, 5916, 5920},
  {544013,545312, 5930, 5930},
  {544013,544886, 5946, 5947},
  {544968,545312, 5946, 5947},
  {544013,545312, 5948, 5949},
  {544013,545312, 5955, 5955},
  {544013,545312, 5975, 5975},
  {544013,545312, 5980, 5984},
  {544013,545312, 6013, 6013},
  {544013,545312, 6015, 6015},
  {544013,545312, 6017, 6017},
  // NB
  {544886,545312, 6052, 6052},
  {544013,545312, 6059, 6059},
  {544013,545312, 6107, 6107},
  {544868,545312, 6165, 6165},
  {544013,545312, 6250, 6250},
  {544013,545312, 6252, 6254},
  // 402 B
  {544013,544896, 6289, 6293},
  {544013,545312, 6293, 6293},
  {544013,545312, 6308, 6309},
  {544013,545312, 6397, 6397},
  {544992,545312, 6419, 6421},
  {544013,545312, 6455, 6455},
  {544013,545312, 6447, 6447},
  {544013,545312, 6457, 6461},
  // NB
  {544868,545312, 6511, 6511},
  {544013,545312, 6528, 6528},
  {544013,545312, 6653, 6653},
  {544013,545312, 6665, 6666},
  // 403 B
  {544013,545312, 6724, 6724},
  {544013,545312, 6726, 6726},
  {544013,545312, 6745, 6745},
  {544013,544813, 6748, 6748},
  {544013,545312, 6759, 6759},
  {544013,545312, 6769, 6769},
  {544013,544868, 6795, 6796},
  {544013,545312, 6814, 6814},
  {544013,545312, 6894, 6898},
  // NB
  {544013,545312, 6942, 6942},
  {544013,544813, 6969, 6969},
  {544013,545312, 6979, 6979},
  {544013,544813, 7035, 7035},
  {544013,545312, 7035, 7035},
  {544013,545312, 7039, 7039},
  {544013,545312, 7060, 7060},
  {544013,545312, 7094, 7094},
  // 501 B
  {544013,545312, 7226, 7230},
  {544013,545312, 7246, 7249},
  // NB
  {544013,545312, 7281, 7283},
  {544013,545312, 7295, 7297},
  // 503 B
  // NB
  {544813,545312, 7430, 7430},
  {544013,545312, 7438, 7438},
  {544013,545312, 7439, 7450},
  // 508 B
  {544013,545312, 7656, 7656},
  {544013,545312, 7702, 7703},
  // NB
  {544013,545312, 7742, 7743},
  // 512 B
  {544013,544185, 8019, 8019},
  // NB
  {544693,544767, 8044, 8044},
  {544693,544813, 8045, 8046},
  {544013,544185, 8044, 8046},
  // 514 B
  {544013,545312, 8099, 8099},
  // 514 NB
  {544013,545312, 8117, 8118},
  // 515 B
  {544013,545312, 8126, 8126},
  // 601 B
  {544013,545312, 8466, 8466},
  {544013,545312, 8471, 8475},
  // 601 NB
  {544013,545312, 8513, 8513},
  // 604 B
  {544868,545312, 8665, 8674},
  // 604 NB
  {544868,545312, 8685, 8690},
  // 606 B
  {544013,545312, 8748, 8748},
  // NB
  {544013,545312, 8766, 8768},
  // 608 B
  {544389,544813, 8923, 8923},
  {544013,545312, 8925, 8925},
  // 610 B
  // NB
  {544013,544185, 9138, 9138},
  // 611 B
  // NB
  {544013,545312, 9212, 9212},
  // 611 B
  {544013,545312, 9284, 9284},
  {544013,544868, 9285, 9285},
  {544013,545312, 9287, 9288},
  // NB
  // 715 B
  {544389,544961,10639,10639},
  {544013,545312,10642,10643},
  {544013,545312,10662,10662},
  {544389,544961,10683,10684},
  // 715 NB
  {544389,544961,10702,10703},
  {544013,545312,10705,10707},
  {544389,544961,10737,10738},
  // 725 B
  {544013,545312,11249,11250},
  {544389,544551,11251,11253},
  {544886,545223,11251,11253},
  // 802 B
  {544013,545312,11531,11531},
  // 802 NB
  {544013,545312,11588,11588},
  // 814 B
  {544121,544392,12297,12298},
  // 815 B
  {544013,545312,12370,12370},
  // 901 NB
  {544914,544963,13180,13183},
  {545291,545312,13180,13183},
  {544914,544963,13188,13191},
  {545291,545312,13188,13191},
  // 906 NB
  {544013,545312,13536,13537},
  // 918 NB
  {544013,545312,14458,14458},
  // NB
  // 1006 B
  {544013,545312,15417,15417},
  // NB
  // 1009 B
  {544013,545312,15515,15516},
  {544013,545312,15523,15523},
  // NB
  // 1013 B
  {544013,545312,15885,15886},
  {544013,545312,15888,15888},
  // 1019 NB
  {544013,545312,16386,16387},
  // 1024 B
  // NB
  {544013,545312,16696,16696},
  {544013,545312,16699,16699},
  {544013,545312,16708,16708},
  // 1025 NB
  {544013,545312,16816,16816},
  {544013,545312,16818,16819},
};

// runMin, runMax, dsMin, dsMax
std::vector<std::tuple<int,int,int,int>> allowedRectangles =
{
  // 510 B
  {544013,545312, 7829, 7829},
  // 515 B
  {544013,545312, 8123, 8123},
  // 600 B
  {544013,545312, 8352, 8352},
  {544013,545312, 8388, 8388},
  {544013,545312, 8399, 8400},
  {544013,545312, 8422, 8422},
  // 700 B
  {544013,545312, 9585, 9585},
  // 725 NB
  {544013,545312,11270,11270},
  // 916 NB
  {544013,545312,14301,14301},
  // 917 NB
  {544013,545312,14417,14417},
  // 923 NB
  {544013,545312,14667,14667},
};

bool checkBannedByRect(int run, int ds) {
  for (auto& rect : bannedRectangles) {
    int runMin = std::get<0>(rect);
    int runMax = std::get<1>(rect);
    int dsMin = std::get<2>(rect);
    int dsMax = std::get<3>(rect);
    if (run >= runMin && run <= runMax && ds >= dsMin && ds <= dsMax)
      return true;
  }
  return false;
}

bool checkAllowedByRect(int run, int ds) {
  for (auto& rect : allowedRectangles) {
    int runMin = std::get<0>(rect);
    int runMax = std::get<1>(rect);
    int dsMin = std::get<2>(rect);
    int dsMax = std::get<3>(rect);
    if (run >= runMin && run <= runMax && ds >= dsMin && ds <= dsMax)
      return true;
  }
  return false;
}

void filter()
{
  SetStyle();

  auto* fdigits = new TFile("digits.root", "r");

  std::map<int, std::vector<int>> deIdsPerChamber{};
  deIdsPerChamber[1] = {100, 101, 102, 103};
  deIdsPerChamber[2] = {200, 201, 202, 203};
  deIdsPerChamber[3] = {300, 301, 302, 303};
  deIdsPerChamber[4] = {400, 401, 402, 403};
  deIdsPerChamber[5] = {500, 501, 502, 503, 504, 505, 506, 507, 508, 509, 510, 511, 512, 513, 514, 515, 516, 517};
  deIdsPerChamber[6] = {600, 601, 602, 603, 604, 605, 606, 607, 608, 609, 610, 611, 612, 613, 614, 615, 616, 617};
  deIdsPerChamber[7] = {700, 701, 702, 703, 704, 705, 706, 707, 708, 709, 710, 711, 712, 713, 714, 715, 716, 717, 718, 719, 720, 721, 722, 723, 724, 725};
  deIdsPerChamber[8] = {800, 801, 802, 803, 804, 805, 806, 807, 808, 809, 810, 811, 812, 813, 814, 815, 816, 817, 818, 819, 820, 821, 822, 823, 824, 825};
  deIdsPerChamber[9] = {900, 901, 902, 903, 904, 905, 906, 907, 908, 909, 910, 911, 912, 913, 914, 915, 916, 917, 918, 919, 920, 921, 922, 923, 924, 925};
  deIdsPerChamber[10] = {1000, 1001, 1002, 1003, 1004, 1005, 1006, 1007, 1008, 1009, 1010, 1011, 1012, 1013, 1014, 1015, 1016, 1017, 1018, 1019, 1020, 1021, 1022, 1023, 1024, 1025};

  gSystem->Exec("if [[ ! -d figures_digits ]]; then mkdir figures; fi");
  auto* fout = new TFile("./figures/filter.root", "recreate");
  auto* l_out = new TList();

  int nRuns = 0;

  std::map<std::string, TH2D*> mapTrendsPerDE{};

  std::fstream fs("banned_ds.list", std::fstream::out);

  for (const auto& [chId, deIds] : deIdsPerChamber) {
    for (auto deId : deIds) {
      for (auto side : {"B", "NB"}) {
        auto* hDigits = dynamic_cast<TH2D*>(fdigits->Get(Form("hTrendDSperDE%d%s", deId, side)));
        hDigits->SetName(Form("hTrendDSperDE%d", deId));
        auto* hFilter = dynamic_cast<TH2D*>(hDigits->Clone(Form("hTrendDSperDE%d%s_filter", deId, side)));
        if (nRuns == 0) nRuns = hDigits->GetNbinsX();
        for (int ir = 1; ir <= hDigits->GetNbinsX(); ++ir) {
          int run = std::stoi(hDigits->GetXaxis()->GetBinLabel(ir));
          for (int ids = 1; ids <= hDigits->GetNbinsY(); ++ids) {
            int ds = trunc(hDigits->GetYaxis()->GetBinLowEdge(ids));
            bool isBannedByRect = checkBannedByRect(run, ds);
            bool isAllowedByRect = checkAllowedByRect(run, ds);
            double ndig = hDigits->GetBinContent(ir, ids);
            bool isBanned = false;
            if (ndig < 0.5)                 { hFilter->SetBinContent(ir, ids, 1.5);  isBanned = true; }
            if (ndig < 0.66 && deId == 300) { hFilter->SetBinContent(ir, ids, 1.5);  isBanned = true; }
            if (ndig < 0.66 && deId == 301) { hFilter->SetBinContent(ir, ids, 1.5);  isBanned = true; }
            if (ndig < 0.66 && deId == 302) { hFilter->SetBinContent(ir, ids, 1.5);  isBanned = true; }
            if (ndig < 0.66 && deId == 400) { hFilter->SetBinContent(ir, ids, 1.5);  isBanned = true; }
            if (ndig < 0.66 && deId == 401) { hFilter->SetBinContent(ir, ids, 1.5);  isBanned = true; }
            if (ndig < 0.66 && deId == 403) { hFilter->SetBinContent(ir, ids, 1.5);  isBanned = true; }
            if (isBannedByRect)             { hFilter->SetBinContent(ir, ids, 2.);   isBanned = true; }
            if (isAllowedByRect)            { hFilter->SetBinContent(ir, ids, ndig); isBanned = false; }
            if (isBanned) {
              fs << Form("%d %d\n", run, ds);
            }
          }
        }
        mapTrendsPerDE[hFilter->GetName()] = hFilter;
        l_out->Add(hFilter);
      }
    }
  }

  fs.close();

  // draw/store distributions

  auto* ctrend = new TCanvas("ctrend", "ctrend", 5000, 3000);
  ctrend->cd();

  auto* padLeft = new TPad("padLeft", "padLeft", 0., 0., 0.5, 1.);
  padLeft->SetLeftMargin(0.08);
  padLeft->SetRightMargin(0.);
  padLeft->SetTopMargin(0.07);
  padLeft->SetBottomMargin(0.11);
  padLeft->Draw();

  auto* padRight = new TPad("padRight", "padRight", 0.5, 0., 1., 1.);
  padRight->SetLeftMargin(0.08);
  padRight->SetRightMargin(0.15);
  padRight->SetRightMargin(0.005);
  padRight->SetTopMargin(0.07);
  padRight->SetBottomMargin(0.11);
  padRight->Draw();

  for (auto& [chId, deIds] : deIdsPerChamber) {
    for (auto deId : deIds) {
      auto* hTrendDSperDE_B = mapTrendsPerDE.at(Form("hTrendDSperDE%dB_filter", deId));
      auto* hTrendDSperDE_NB = mapTrendsPerDE.at(Form("hTrendDSperDE%dNB_filter", deId));
      setHist(hTrendDSperDE_B);
      setHist(hTrendDSperDE_NB);
      ctrend->cd();
      padLeft->cd();
      hTrendDSperDE_B->SetTitle(Form("DE%d Bending", deId));
      hTrendDSperDE_B->GetZaxis()->SetRangeUser(0., 2.);
      hTrendDSperDE_B->Draw("col");
      ctrend->cd();
      padRight->cd();
      hTrendDSperDE_NB->SetTitle(Form("DE%d Non-Bending", deId));
      hTrendDSperDE_NB->GetZaxis()->SetRangeUser(0., 2.);
      hTrendDSperDE_NB->Draw("col");
      ctrend->cd();
      if (deId == 100)
        ctrend->Print("./figures/trending_filter_ds_per_de.pdf(", Form("Title: DE%d", deId));
      else if (deId == 1025)
        ctrend->Print("./figures/trending_filter_ds_per_de.pdf)", Form("Title: DE%d", deId));
      else
        ctrend->Print("./figures/trending_filter_ds_per_de.pdf", Form("Title: DE%d", deId));
    }
  }

  fout->cd();
  l_out->Write();
}
